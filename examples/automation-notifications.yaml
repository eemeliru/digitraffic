# Automation: Notify on New Traffic Messages
#
# This automation monitors Digitraffic traffic message sensors and sends
# a mobile notification when a new message is detected.
#
# Prerequisites:
# 1. Home Assistant mobile app installed on your device
# 2. A configured Digitraffic traffic message service
# 3. Mobile notifications enabled in the app

# ============================================================================
# Example 1: Monitor Specific Service by Device
# ============================================================================
# This monitors only sensors from a specific Digitraffic service device.
# Replace "YOUR_DEVICE_ID" with your actual device ID from the service.
# Find it in: Settings â†’ Devices & Services â†’ Digitraffic â†’ Your Service â†’ Device ID

automation:
  - alias: "Traffic: Notify New Traffic Messages from My Service"
    description: "Send notification when new traffic message appears in my monitored area."

    trigger:
      # Trigger when entities are added/updated on the specific device
      - platform: event
        event_type: entity_registry_updated
        event_data:
          action: create

    condition:
      # Check if the entity is from our Digitraffic service device
      - condition: template
        value_template: >
          {{ trigger.event.data.entity_id is defined
             and trigger.event.data.entity_id.startswith('sensor.digitraffic_tm_')
             and device_id(trigger.event.data.entity_id) == 'YOUR_DEVICE_ID' }}
      # Optional: Only notify during commute hours
      - condition: time
        after: "06:00:00"
        before: "20:00:00"

    action:
      - service: notify.mobile_app_your_phone
        data:
          title: "ğŸš¨ New Traffic Message"
          message: >
            {{ states[trigger.event.data.entity_id].name }}

            Location: {{ state_attr(trigger.event.data.entity_id, 'municipalities') }}
            Type: {{ state_attr(trigger.event.data.entity_id, 'situation_type_label') }}

            {{ state_attr(trigger.event.data.entity_id, 'description') }}

---

# ============================================================================
# Example 2: Monitor by Service Name
# ============================================================================
# This monitors sensors by filtering on the service device name.
# Useful when you know the exact service name.

automation:
  - alias: "Traffic: Notify Helsinki Service Messages"
    description: "Notify about traffic messages from Helsinki service"

    trigger:
      - platform: event
        event_type: entity_registry_updated
        event_data:
          action: create

    condition:
      # Check if it's a digitraffic sensor from the specific service
      - condition: template
        value_template: >
          {{ trigger.event.data.entity_id is defined
             and trigger.event.data.entity_id.startswith('sensor.digitraffic_tm_')
             and device_attr(device_id(trigger.event.data.entity_id), 'name') == 'Traffic: Helsinki - All types' }}

    action:
      - service: notify.mobile_app_your_phone
        data:
          title: "âš ï¸ Helsinki Traffic Alert"
          message: >
            {{ states[trigger.event.data.entity_id].name }}

            ğŸ“ {{ state_attr(trigger.event.data.entity_id, 'municipalities') }}
            ğŸ›£ï¸ Road {{ state_attr(trigger.event.data.entity_id, 'road') }}

            {{ state_attr(trigger.event.data.entity_id, 'description') }}

---

# ============================================================================
# Example 3: Filter by Device and Situation Type
# ============================================================================
# Monitor a specific service and only notify for certain incident types.

automation:
  - alias: "Traffic: Notify Road Works from My Service"
    description: "Send notification only for Road Work messages from my service"

    trigger:
      - platform: event
        event_type: entity_registry_updated
        event_data:
          action: create

    condition:
      # Check if it's a digitraffic sensor from our device
      - condition: template
        value_template: >
          {{ trigger.event.data.entity_id is defined
             and trigger.event.data.entity_id.startswith('sensor.digitraffic_tm_')
             and device_id(trigger.event.data.entity_id) == 'YOUR_DEVICE_ID' }}
      # Only trigger for Road Works
      - condition: template
        value_template: >
          {{ state_attr(trigger.event.data.entity_id, 'situation_type') == 'ROAD_WORK' }}

    action:
      - service: notify.mobile_app_your_phone
        data:
          title: "ğŸš§ Road Work Alert"
          message: >
            {{ states[trigger.event.data.entity_id].name }}

            ğŸ“ {{ state_attr(trigger.event.data.entity_id, 'location_description') }}
            â° {{ state_attr(trigger.event.data.entity_id, 'time_and_duration') }}

            {{ state_attr(trigger.event.data.entity_id, 'description') }}

---